# II. 요구분석

## 1. 용어정의

본 프로젝트에서 사용되는 주요 용어를 정의한다.

| 용어 | 영문 | 정의 |
|------|------|------|
| 환자 | Patient | 의료 서비스를 받기 위해 시스템을 이용하는 일반 사용자 |
| 의사 | Doctor | 병원에 소속되어 진료를 제공하는 의료 전문가 |
| 관리자 | Administrator | 시스템 전체를 관리하고 설정하는 권한을 가진 사용자 |
| 예약 | Appointment | 환자가 특정 날짜와 시간에 의사의 진료를 받기 위한 사전 약속 |
| 진료 기록 | Medical Record | 환자가 받은 진료의 내역, 진단, 처방 등을 기록한 문서 |
| JWT | JSON Web Token | 사용자 인증을 위한 토큰 기반 인증 방식 |
| API | Application Programming Interface | 클라이언트와 서버 간 데이터 통신을 위한 인터페이스 |
| RESTful | Representational State Transfer | HTTP 프로토콜 기반의 아키텍처 스타일 |
| SPA | Single Page Application | 단일 페이지로 구성된 웹 애플리케이션 |
| CRUD | Create, Read, Update, Delete | 데이터베이스의 기본 연산 |
| GPS | Global Positioning System | 위성 기반 위치 확인 시스템 |
| FCM | Firebase Cloud Messaging | Google의 푸시 알림 서비스 |
| SQL Injection | - | SQL 쿼리 삽입을 통한 보안 공격 기법 |
| XSS | Cross-Site Scripting | 악성 스크립트 삽입 공격 |
| CORS | Cross-Origin Resource Sharing | 교차 출처 리소스 공유 |
| bcrypt | - | 비밀번호 해싱 알고리즘 |
| 노쇼 | No-show | 예약 후 통보 없이 방문하지 않는 현상 |

## 2. 개요

DoctorLink는 환자와 의료 기관을 연결하는 통합 의료 예약 플랫폼이다. 웹 애플리케이션과 모바일 애플리케이션을 통해 24시간 언제 어디서나 병원을 검색하고 예약할 수 있으며, 자신의 진료 기록을 체계적으로 관리할 수 있다.

### 2.1 시스템 개요

**시스템 유형**: 클라이언트-서버 아키텍처 기반 웹/모바일 애플리케이션

**주요 사용자**:
- **환자**: 병원 검색, 예약, 진료 기록 조회
- **의사**: 예약 관리, 진료 기록 작성
- **관리자**: 사용자 관리, 병원 관리, 시스템 설정

**플랫폼**:
- **웹**: Chrome, Firefox, Safari, Edge 지원
- **모바일**: Android 10.0+, iOS 13.0+ 지원

### 2.2 시스템 구성

```
┌─────────────────────────────────────────────┐
│          사용자 (Clients)                    │
├──────────────┬──────────────┬───────────────┤
│   웹 브라우저  │  Android 앱  │   iOS 앱      │
│   (React)    │(React Native)│(React Native) │
└──────────────┴──────────────┴───────────────┘
        │                │              │
        └────────────────┼──────────────┘
                         │
                    HTTPS/REST API
                         │
         ┌───────────────▼───────────────┐
         │     백엔드 서버 (Backend)      │
         │    Node.js + Express.js       │
         │         (Port 3000)           │
         └───────────────┬───────────────┘
                         │
                    SQL 쿼리
                         │
         ┌───────────────▼───────────────┐
         │   데이터베이스 (Database)      │
         │    Microsoft SQL Server       │
         │         (Port 1433)           │
         └───────────────────────────────┘
```

### 2.3 기술 스택

**프론트엔드**
- React 18.2.0 (웹)
- React Native 0.79.0 (모바일)
- TypeScript 4.9.5
- React Navigation, React Native Paper

**백엔드**
- Node.js 18.x
- Express.js 4.x
- JWT 인증
- bcrypt 해싱

**데이터베이스**
- Microsoft SQL Server 2019

## 3. 기능 분석

### 3.1 사용자 인증 및 관리

**3.1.1 회원가입**
- **입력**: 이메일, 비밀번호, 이름, 전화번호, 생년월일, 성별, 역할
- **처리**:
  1. 이메일 중복 확인 (DB 조회)
  2. 입력 유효성 검증 (이메일 형식, 비밀번호 강도)
  3. 비밀번호 bcrypt 해싱
  4. DB에 사용자 정보 저장
- **출력**: 성공 시 JWT 토큰 발급, 실패 시 에러 메시지
- **에러 처리**:
  - 이메일 중복: "이미 사용 중인 이메일입니다."
  - 유효성 실패: "비밀번호는 8자 이상이어야 합니다."

**3.1.2 로그인**
- **입력**: 이메일, 비밀번호
- **처리**:
  1. 이메일로 사용자 조회
  2. bcrypt로 비밀번호 검증
  3. 일치 시 JWT 토큰 생성 (Payload: userId, role)
- **출력**: JWT 토큰 및 사용자 정보
- **보안**:
  - 토큰 유효기간: 7일
  - 잘못된 로그인 시도 로깅

**3.1.3 프로필 수정**
- **입력**: 이름, 전화번호, 주소, 의료 정보 (혈액형, 알레르기 등)
- **처리**: 
  1. JWT 토큰으로 사용자 인증
  2. 입력 유효성 검증
  3. DB 업데이트
- **출력**: 업데이트된 사용자 정보

### 3.2 병원 검색 및 조회

**3.2.1 키워드 검색**
- **입력**: 검색어 (병원명, 주소, 진료과)
- **처리**:
  ```sql
  SELECT * FROM Hospitals 
  WHERE Name LIKE '%검색어%' 
     OR Address LIKE '%검색어%'
     OR City LIKE '%검색어%'
  ```
- **출력**: 병원 목록 (이름, 주소, 전화번호, 평점)

**3.2.2 GPS 기반 검색**
- **입력**: 사용자 현재 위치 (위도, 경도)
- **처리**:
  1. Geolocation API로 현재 위치 확인
  2. 하버사인 공식으로 거리 계산
  ```javascript
  distance = 2 * R * arcsin(sqrt(sin²((lat2-lat1)/2) + cos(lat1)*cos(lat2)*sin²((lon2-lon1)/2)))
  ```
  3. 거리순 정렬
- **출력**: 반경 5km 내 병원 목록 (거리 포함)

**3.2.3 필터링**
- **병원 유형**: 종합병원, 병원, 의원, 치과, 한의원
- **진료과**: 내과, 외과, 정형외과, 소아과, 산부인과 등
- **정렬 기준**: 거리순, 평점순, 이름순, 리뷰 많은 순

**3.2.4 병원 상세 정보**
- **입력**: 병원 ID
- **출력**:
  - 기본 정보: 이름, 주소, 전화번호, 진료 시간
  - 소속 의사: 이름, 전문 분야, 경력
  - 리뷰: 평점, 리뷰 내용, 작성자
  - 위치: 카카오맵 연동 지도

### 3.3 예약 관리

**3.3.1 예약 생성**
- **프로세스**:
  1. **병원 선택**: 검색 결과에서 병원 선택
  2. **의사 선택**: 해당 병원 소속 의사 목록 조회
  3. **날짜 선택**: 캘린더에서 날짜 선택
  4. **시간 선택**: 가능한 시간 슬롯 조회 및 선택
  5. **증상 입력**: 방문 사유 및 추가 메모 작성
  6. **예약 확정**: DB에 예약 정보 저장

- **가능 시간 조회 API**:
  ```sql
  -- 이미 예약된 시간 제외
  SELECT TimeSlot FROM AvailableSlots
  WHERE DoctorID = ? AND Date = ?
  AND TimeSlot NOT IN (
    SELECT AppointmentTime FROM Appointments
    WHERE DoctorID = ? AND AppointmentDate = ?
  )
  ```

- **동시성 제어**: 트랜잭션 사용
  ```javascript
  await db.transaction(async (trx) => {
    // 1. 중복 예약 확인
    const existing = await trx('Appointments').where({...}).first();
    if (existing) throw new Error('이미 예약된 시간입니다.');
    
    // 2. 예약 생성
    await trx('Appointments').insert({...});
  });
  ```

**3.3.2 예약 조회**
- **환자**: 본인의 예약 목록
- **의사**: 자신에게 접수된 예약 목록
- **관리자**: 모든 예약 목록

- **필터링**: 상태별 (대기, 승인, 완료, 취소), 날짜별

**3.3.3 예약 수정**
- **조건**: 예약 시간 2시간 전까지만 수정 가능
- **처리**:
  ```javascript
  const now = new Date();
  const appointmentTime = new Date(appointment.date + ' ' + appointment.time);
  const timeDiff = (appointmentTime - now) / (1000 * 60 * 60); // 시간 단위
  
  if (timeDiff < 2) {
    throw new Error('예약 2시간 전에는 수정할 수 없습니다.');
  }
  ```

**3.3.4 예약 취소**
- **조건**: 예약 시간 1시간 전까지만 취소 가능
- **처리**: 예약 상태를 'cancelled'로 업데이트
- **알림**: 의사에게 취소 알림 전송

### 3.4 진료 기록 관리

**3.4.1 진료 기록 작성 (의사 전용)**
- **입력**:
  - 진단명 (Diagnosis)
  - 치료 내용 (Treatment)
  - 처방전 (Prescription)
  - 첨부 파일 (검사 결과, X-ray 등)
- **처리**: DB에 저장, 예약 상태 'completed'로 변경
- **권한**: 해당 예약의 담당 의사만 작성 가능

**3.4.2 진료 기록 조회**
- **환자**: 본인의 진료 기록만 조회
- **의사**: 자신이 작성한 진료 기록 조회
- **관리자**: 모든 진료 기록 조회

- **검색**: 진단명, 치료 내용, 메모로 검색

**3.4.3 진료 기록 상세**
- **출력**:
  - 기본 정보: 진료 날짜, 병원명, 의사명
  - 진단 및 치료: 진단명, 치료 내용
  - 처방전: 약품명, 용량, 복용법
  - 첨부 파일: 이미지 미리보기 또는 다운로드

### 3.5 알림 시스템

**3.5.1 알림 유형**
- **예약 확정**: 예약이 승인되었을 때
- **예약 리마인더**: 예약 1일 전, 1시간 전
- **예약 변경**: 예약 시간이 변경되었을 때
- **예약 취소**: 예약이 취소되었을 때
- **시스템 공지**: 중요 공지사항
- **프로모션**: 이벤트 및 할인 정보

**3.5.2 알림 전송**
- **푸시 알림**: FCM (계획 중)
- **이메일**: SMTP 서버 연동 (계획 중)
- **인앱 알림**: 앱 내 알림 목록

**3.5.3 알림 관리**
- 알림 목록 조회
- 읽음/안 읽음 표시
- 개별 삭제 또는 전체 삭제
- 알림 설정 (알림 유형별 ON/OFF)

### 3.6 리뷰 시스템

**3.6.1 리뷰 작성**
- **조건**: 진료 완료 후에만 작성 가능
- **입력**: 평점 (1~5점), 리뷰 내용
- **처리**: DB 저장, 병원 평균 평점 업데이트

**3.6.2 리뷰 조회**
- 병원별 리뷰 목록
- 평점 높은 순, 최신순 정렬
- 리뷰 통계: 평균 평점, 총 리뷰 수, 평점 분포

### 3.7 관리자 기능

**3.7.1 대시보드**
- **통계 데이터**:
  ```sql
  SELECT 
    (SELECT COUNT(*) FROM Users WHERE Role = 'patient') AS TotalPatients,
    (SELECT COUNT(*) FROM Hospitals) AS TotalHospitals,
    (SELECT COUNT(*) FROM Appointments) AS TotalAppointments,
    (SELECT COUNT(*) FROM Appointments WHERE Status = 'pending') AS PendingAppointments,
    (SELECT COUNT(*) FROM Appointments WHERE AppointmentDate = CAST(GETDATE() AS DATE)) AS TodayAppointments
  ```

- **차트**: Chart.js를 이용한 예약 추이 그래프

**3.7.2 사용자 관리**
- CRUD 기능: 생성, 조회, 수정, 삭제
- 역할 변경: 환자 ↔ 의사, 관리자 권한 부여
- 계정 활성화/비활성화

**3.7.3 병원 관리**
- 병원 등록 승인/거부
- 병원 정보 수정
- 의사 배정 및 관리

**3.7.4 콘텐츠 관리**
- 공지사항 CRUD
- FAQ CRUD
- 1:1 문의 답변

## 4. 참고문헌

[1] IEEE Standard 830-1998, "IEEE Recommended Practice for Software Requirements Specifications"

[2] Ian Sommerville, "Software Engineering (10th Edition)", Pearson, 2015

[3] World Wide Web Consortium (W3C), "Web Content Accessibility Guidelines (WCAG) 2.1", 2018

[4] OWASP Foundation, "OWASP Top Ten Web Application Security Risks", 2021

[5] Martin Fowler, "Patterns of Enterprise Application Architecture", Addison-Wesley, 2002


